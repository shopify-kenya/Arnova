#!/bin/bash
# Pre-commit hook for Arnova Next.js + Django project

echo "üîç Running pre-commit checks..."

# Get list of staged files
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' | grep -v 'migrations/' | grep -v '.venv/' | grep -v 'venv/')
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|json|css|md)$')

# Format Python files
if [ -n "$STAGED_PY_FILES" ]; then
    echo "üêç Formatting Python files..."

    # Check formatting first
    if ! black --check . --exclude="/(migrations|venv|.venv|node_modules)/" 2>/dev/null; then
        echo "Black not available or formatting issues found"
    fi

    if ! isort --check-only . --skip=migrations --skip=venv --skip=.venv --skip=node_modules 2>/dev/null; then
        echo "isort not available or import order issues found"
    fi

    # Apply formatting
    echo "$STAGED_PY_FILES" | xargs black 2>/dev/null || echo "Black not available"
    echo "$STAGED_PY_FILES" | xargs isort 2>/dev/null || echo "isort not available"
    echo "$STAGED_PY_FILES" | xargs git add
fi

# Format JavaScript/TypeScript files
if [ -n "$STAGED_JS_FILES" ]; then
    echo "‚öõÔ∏è Formatting JS/TS files..."
    echo "$STAGED_JS_FILES" | xargs npx prettier --write 2>/dev/null || echo "Prettier not available"
    echo "$STAGED_JS_FILES" | xargs git add
fi

# Run linting on staged files only
if [ -n "$STAGED_PY_FILES" ]; then
    echo "üîß Running Python linter..."
    if ! flake8 . --exclude=migrations,venv,.venv,node_modules --max-line-length=88 --extend-ignore=E203 2>/dev/null; then
        echo "flake8 not available or linting issues found"
    fi
fi

# Check for trailing whitespace in staged files
if git diff --cached --check; then
    echo "‚úÖ Pre-commit checks passed"
    exit 0
else
    echo "‚ùå Please fix trailing whitespace"
    exit 1
fi
