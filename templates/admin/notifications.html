{% extends 'admin/base.html' %}

{% block title %}Notifications - Arnova Admin{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-5xl font-bold text-foreground mb-2">Notifications</h1>
            <p class="text-muted-foreground">Manage your notifications</p>
        </div>
        <button onclick="markAllAsRead()" class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors">
            Mark All as Read
        </button>
    </div>

    <!-- Notifications List -->
    <div id="notifications-container" class="space-y-4">
        <p class="text-center text-muted-foreground py-8">Loading notifications...</p>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="hidden flex justify-center mt-6">
        <nav class="glass rounded-xl px-6 py-3 flex items-center space-x-4">
            <button id="prev-btn" class="px-3 py-1 text-muted-foreground hover:text-foreground transition-colors disabled:opacity-50" disabled>
                Previous
            </button>
            <span id="page-info" class="px-3 py-1 text-foreground font-medium">Page 1</span>
            <button id="next-btn" class="px-3 py-1 text-muted-foreground hover:text-foreground transition-colors disabled:opacity-50" disabled>
                Next
            </button>
        </nav>
    </div>
</div>

<script>
    let currentPage = 1;
    let allNotifications = [];

    async function loadNotifications() {
        try {
            const response = await fetch('/graphql/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    query: `
                        query Notifications {
                            notifications {
                                items {
                                    id
                                    title
                                    message
                                    type
                                    isRead
                                    link
                                    createdAt
                                }
                            }
                        }
                    `
                })
            });
            const payload = await response.json();
            allNotifications = payload?.data?.notifications?.items || [];
            renderNotifications();
        } catch (error) {
            document.getElementById('notifications-container').innerHTML = `
                <div class="text-center py-8">
                    <p class="text-red-600">Failed to load notifications</p>
                    <button onclick="loadNotifications()" class="mt-4 px-4 py-2 bg-primary text-primary-foreground rounded-lg">
                        Retry
                    </button>
                </div>
            `;
        }
    }

    function renderNotifications() {
        const container = document.getElementById('notifications-container');

        if (allNotifications.length === 0) {
            container.innerHTML = `
                <div class="glass-strong rounded-2xl p-12 text-center acrylic-card">
                    <svg class="mx-auto h-16 w-16 text-muted-foreground mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <h3 class="text-xl font-bold text-foreground mb-2">No notifications</h3>
                    <p class="text-muted-foreground">You're all caught up!</p>
                </div>
            `;
            return;
        }

        container.innerHTML = allNotifications.map(n => `
            <div class="glass-strong rounded-2xl p-6 acrylic-card hover:scale-[1.01] transition-transform cursor-pointer ${n.isRead ? 'opacity-60' : ''}"
                 onclick="markAsRead(${n.id}, '${n.link || ''}')">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            ${getTypeIcon(n.type)}
                            <h3 class="text-lg font-bold text-foreground">${escapeHtml(n.title)}</h3>
                            ${!n.isRead ? '<div class="w-2 h-2 bg-blue-500 rounded-full"></div>' : ''}
                        </div>
                        <p class="text-muted-foreground mb-3">${escapeHtml(n.message)}</p>
                        <div class="flex items-center gap-4 text-sm text-muted-foreground">
                            <span>${new Date(n.createdAt).toLocaleString()}</span>
                            <span class="px-2 py-1 bg-primary/10 text-primary rounded-full text-xs">${n.type}</span>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function getTypeIcon(type) {
        const icons = {
            order: '<svg class="h-5 w-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>',
            product: '<svg class="h-5 w-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>',
            user: '<svg class="h-5 w-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>',
            system: '<svg class="h-5 w-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        };
        return icons[type] || icons.system;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function markAsRead(id, link) {
        try {
            await fetch('/graphql/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    query: `
                        mutation MarkNotificationRead($notificationId: Int!) {
                            markNotificationRead(notificationId: $notificationId) {
                                success
                            }
                        }
                    `,
                    variables: { notificationId: id }
                })
            });
            if (link) {
                window.location.href = link;
            } else {
                loadNotifications();
            }
        } catch (error) {
        }
    }

    async function markAllAsRead() {
        try {
            await fetch('/graphql/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    query: `
                        mutation MarkAllNotificationsRead {
                            markAllNotificationsRead {
                                success
                            }
                        }
                    `
                })
            });
            loadNotifications();
        } catch (error) {
        }
    }

    // Load notifications on page load
    document.addEventListener('DOMContentLoaded', loadNotifications);
</script>
{% endblock %}
