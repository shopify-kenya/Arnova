{% extends 'admin/base.html' %}

{% block title %}Profile - Arnova Admin{% endblock %}

{% block content %}
<div class="space-y-8">
    <div>
        <h1 class="text-5xl font-bold text-foreground mb-2">My Profile</h1>
        <p class="text-muted-foreground">Manage your account information</p>
    </div>

    <div class="glass-strong rounded-2xl p-8 acrylic-card max-w-3xl">
        <form id="profileForm" class="space-y-6">
            {% csrf_token %}
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">First Name</label>
                    <input type="text" name="first_name" id="first_name"
                           class="form-input w-full px-4 py-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Last Name</label>
                    <input type="text" name="last_name" id="last_name"
                           class="form-input w-full px-4 py-2 rounded-lg">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Username</label>
                <input type="text" id="username" disabled
                       class="w-full px-4 py-2 rounded-lg border bg-muted opacity-60">
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Email</label>
                <input type="email" name="email" id="email"
                       class="form-input w-full px-4 py-2 rounded-lg">
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Phone</label>
                <input type="text" name="phone" id="phone"
                       class="form-input w-full px-4 py-2 rounded-lg">
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Address</label>
                <textarea name="address" id="address" rows="3"
                          class="form-input w-full px-4 py-2 rounded-lg"></textarea>
            </div>

            <div class="grid grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2">City</label>
                    <input type="text" name="city" id="city"
                           class="form-input w-full px-4 py-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Country</label>
                    <input type="text" name="country" id="country"
                           class="form-input w-full px-4 py-2 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Postal Code</label>
                    <input type="text" name="postal_code" id="postal_code"
                           class="form-input w-full px-4 py-2 rounded-lg">
                </div>
            </div>

            <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-primary-foreground py-3 rounded-lg font-medium transition-colors">
                Save Changes
            </button>
        </form>
    </div>
</div>

<script>
async function loadProfile() {
    try {
        const res = await fetch('/graphql/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
                query: `
                    query Profile {
                        profile {
                            user {
                                username
                                firstName
                                lastName
                                email
                            }
                            profile {
                                phone
                                address
                                city
                                country
                                postalCode
                            }
                        }
                    }
                `
            })
        });
        const payload = await res.json();
        const data = payload?.data?.profile;
        if (data) {
            document.getElementById('username').value = data.user.username;
            document.getElementById('first_name').value = data.user.firstName || '';
            document.getElementById('last_name').value = data.user.lastName || '';
            document.getElementById('email').value = data.user.email || '';
            document.getElementById('phone').value = data.profile.phone || '';
            document.getElementById('address').value = data.profile.address || '';
            document.getElementById('city').value = data.profile.city || '';
            document.getElementById('country').value = data.profile.country || '';
            document.getElementById('postal_code').value = data.profile.postalCode || '';
        }
    } catch (error) {
        alert('Unable to load profile. Please refresh and try again.');
    }
}

document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    try {
        const res = await fetch('/graphql/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
                query: `
                    mutation UpdateProfile($input: ProfileUpdateInput!) {
                        updateProfile(input: $input) {
                            success
                        }
                    }
                `,
                variables: {
                    input: {
                        firstName: formData.get('first_name'),
                        lastName: formData.get('last_name'),
                        email: formData.get('email'),
                        phone: formData.get('phone'),
                        address: formData.get('address'),
                        city: formData.get('city'),
                        country: formData.get('country'),
                        postalCode: formData.get('postal_code'),
                    }
                }
            })
        });
        const payload = await res.json();
        if (payload?.data?.updateProfile?.success) {
            alert('Profile updated successfully!');
            loadProfile();
        } else {
            alert('Failed to update profile');
        }
    } catch (error) {
        alert('Unable to update profile. Please try again.');
    }
});

document.addEventListener('DOMContentLoaded', loadProfile);
</script>
{% endblock %}
